<div class="w-screen mx-auto mt-10 p-6 bg-white shadow-md rounded">
  <!-- Document Title and Manage Button -->
  <div class="flex justify-between items-center mb-6">
    <!-- Document Title -->
    <app-input clazz="text-2xl font-bold text-gray-800" [value]="document()?.title" [disabled]="isViewer()"
      (updated)="saveTitle($event)"></app-input>

    <!-- Manage Document Dropdown -->
    @if (isOwner() || isEditor()) {
    <div class="relative inline-block text-left">
      <app-dropdown label="Manage Document" [actions]="getManageDocumentActions()"
        (dropdownItemClicked)="handleManageDocumentActions($event)"></app-dropdown>
    </div>
    <input #fileImportInput type="file" id="fileInput" accept=".json" class="hidden"
      (change)="importDocument($event)" />
    }
  </div>

  <!-- Bill Table -->
  <app-bill-table [headers]="headers()" [data]="enabledBills()" [isOwner]="isOwner()" [isEditor]="isEditor()"
    [isViewer]="isViewer()" (sortTable)="sortTable($event)" (toggleDisabled)="toggleDisabled($event)"
    (openDeleteBillModal)="openDeleteBillModal($event)" (valueUpdate)="saveCell($event)"></app-bill-table>

  <!-- Add New Bill Button -->
  @if (isOwner() || isEditor()) {
  <div class="mt-4 mb-10">
    <app-button text="Add New Bill" color="blue" (click)="addNewBill()"></app-button>
  </div>
  }

  <!-- Disabled Bills -->
  <app-bill-table [headers]="headers()" [data]="disabledBills()" [isOwner]="isOwner()" [isEditor]="isEditor()"
    [isViewer]="isViewer()" (sortTable)="sortTable($event)" (toggleDisabled)="toggleDisabled($event)"
    (openDeleteBillModal)="openDeleteBillModal($event)" (valueUpdate)="saveCell($event)"></app-bill-table>
  <div class="mb-6"></div>

  <!-- Delete Bill Modal -->
  @if (isOwner() || isEditor()) {
  <app-modal [visible]="pendingDeleteBill() !== null" [disabled]="deletingBill()" [loading]="deletingBill()"
    title="Delete Bill" confirmText="delete" closeText="cancel" (confirmAction)="confirmDeleteBill()"
    (closeAction)="closeDeleteBillModal()">
    <p class="text-gray-600 mb-4">Are you sure you want to delete this bill?</p>
    @for (item of pendingDeleteBill() | keyvalue; track item.key) {
    @if (item.key !== '__disabled') {
    <p class="pl-4 mb-1">{{ getHeaderForBillKey(item.key) }}: {{ item.value || '""' }}</p>
    }
    }
  </app-modal>
  }

  <!-- Delete Document Modal -->
  @if (isOwner()) {
  <app-modal [visible]="showDeleteDocumentModal()" [disabled]="deletingDocument()" [loading]="deletingDocument()"
    title="Delete Document" confirmText="delete" closeText="cancel" (confirmAction)="deleteDocument()"
    (closeAction)="closeDeleteDocumentModal()">
    <p class="text-gray-600">Are you sure you want to delete this document? This action cannot be undone.</p>
  </app-modal>
  }

  <!-- Share Document / Import Modal -->
  @if (isOwner() || isEditor()) {
  <app-modal [visible]="showShareModal()" title="Manage Sharing" closeText="done" (closeAction)="closeShareModal()">
    <!-- Add new user -->
    <form (submit)="shareDocument()">
      <div class="flex items-start space-x-4 mb-4">
        <!-- Email input and error container -->
        <div class="flex flex-col w-full">
          <input type="email" name="email" placeholder="Add people by email" [formControl]="shareEmail"
            (keyup)="updateEmailError()" (change)="updateEmailError()" (blur)="updateEmailError()"
            class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
          <!-- Error message under email input -->
          @if (emailError()) {
          <span class="text-red-600 text-sm">{{ emailError() }}</span>
          }
        </div>

        <!-- Role dropdown for new user -->
        <div class="flex items-center">
          <app-dropdown [label]="newUserRole() || 'Select Role'" [actions]="[
            { id: 'viewer', label: 'Viewer' },
            { id: 'editor', label: 'Editor' }
          ]" (dropdownItemClicked)="updateUserRole($event)"></app-dropdown>
        </div>
      </div>

      <div class="flex justify-end mb-4">
        <app-button text="Add" type="submit" color="green" clazz="px-10"
          [disabled]="shareEmail.invalid || newUserRole() === null || sendingShareRequest()"
          [loading]="sendingShareRequest()"></app-button>
      </div>
    </form>

    @if (flatmapAcl()) {
    <h4 class="font-semibold mb-2">Shared With:</h4>
    <ul class="max-h-48 overflow-y-auto border border-gray-200 rounded p-2 space-y-2">
      @for (acl of flatmapAcl(); track acl.email) {
      <li class="flex items-center justify-between hover:bg-gray-100">
        <span class="ml-4 mr-4">{{ acl.email }}</span>
        <div class="flex items-center">
          <app-dropdown [label]="acl.role" [actions]="getAclActions(acl)" [loading]="updatingUserAcl() === acl"
            [disabled]="updatingUserAcl() !== null" (dropdownItemClicked)="handleUpdateAcl($event, acl)"></app-dropdown>
        </div>
      </li>
      } @empty {
      <li class="p-4">Not shared with anyone yet!</li>
      }
    </ul>
    }
  </app-modal>

  <app-modal [visible]="showConfirmRemoveAccessModal()" title="Remove Access" confirmText="remove" closeText="cancel"
    (confirmAction)="confirmRemoveAccess()" (closeAction)="cancelRemoveAccess()">
    <p class="text-gray-600">Are you sure you want to remove access for {{ pendingRemoveAccess()?.email }}?</p>
  </app-modal>

  <app-modal [visible]="showImportModal()" [disabled]="importingFile()" [loading]="importingFile()" title="Import File"
    confirmText="Import" closeText="cancel" (confirmAction)="importModalConfirmAction()"
    (closeAction)="closeImportModal()">
    <p class="text-gray-600">Are you sure you want to import a document? This action will overwrite all existing data.</p>
  </app-modal>
  }
</div>